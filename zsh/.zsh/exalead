# "-*- sh -*-"

source /ng/src/$USER/svn/edk/tools/devenv/zsh/exalead.zsh

typeset -A namedpathes
namedpathes=(
    h ~/public_html

    d /ng/src/$USER/svn/edk/tools/devenv/
    z /ng/src/$USER/svn/edk/tools/devenv/zsh
    o /ng/src/$USER/svn/edk/tools/chmon/

    e /ng/src/$USER/svn/edk/edk/trunk
    e0 /ng/src/$USER/svn/edk/edk/branches/2.0
    e1 /ng/src/$USER/svn/edk/edk/branches/2.1
    e2 /ng/src/$USER/svn/edk/edk/branches/2.2
    e3 /ng/src/$USER/svn/edk/edk/branches/2.3
    e4 /ng/src/$USER/svn/edk/edk/branches/2.4

    i /ng/src/$USER/svn/platform/index6/trunk/
    i1 /ng/src/$USER/svn/platform/index6/branches/1.1
    i2 /ng/src/$USER/svn/platform/index6/branches/1.2
    i3 /ng/src/$USER/svn/platform/index6/branches/1.3
    i4 /ng/src/$USER/svn/platform/index6/branches/1.4
    i5 /ng/src/$USER/svn/platform/index6/branches/1.5

    s /ng/src/$USER/svn/platform/semantic/trunk
    s7 /ng/src/$USER/svn/platform/semantic/branches/1.7
    s8 /ng/src/$USER/svn/platform/semantic/branches/1.8
    s9 /ng/src/$USER/svn/platform/semantic/branches/1.9
    s0 /ng/src/$USER/svn/platform/semantic/branches/1.10
    s1 /ng/src/$USER/svn/platform/semantic/branches/1.11

    l /ng/src/$USER/svn/platform/semantic/trunk/com/exalead/linguistic
    l7 /ng/src/$USER/svn/platform/semantic/branches/1.7/com/exalead/linguistic
    l8 /ng/src/$USER/svn/platform/semantic/branches/1.8/com/exalead/linguistic
    l9 /ng/src/$USER/svn/platform/semantic/branches/1.9/com/exalead/linguistic
    l0 /ng/src/$USER/svn/platform/semantic/branches/1.10/com/exalead/linguistic
    l1 /ng/src/$USER/svn/platform/semantic/branches/1.11/com/exalead/linguistic

    m /ng/src/$USER/svn/platform/semantic/trunk/com/exalead/mot
    m7 /ng/src/$USER/svn/platform/semantic/branches/1.7/com/exalead/mot
    m8 /ng/src/$USER/svn/platform/semantic/branches/1.8/com/exalead/mot
    m9 /ng/src/$USER/svn/platform/semantic/branches/1.9/com/exalead/mot
    m0 /ng/src/$USER/svn/platform/semantic/branches/1.10/com/exalead/mot
    m1 /ng/src/$USER/svn/platform/semantic/branches/1.11/com/exalead/mot

    c /ng/src/$USER/svn/platform/semantic/trunk/com/exalead/mot/components
    c7 /ng/src/$USER/svn/platform/semantic/branches/1.7/com/exalead/mot/components
    c8 /ng/src/$USER/svn/platform/semantic/branches/1.8/com/exalead/mot/components
    c9 /ng/src/$USER/svn/platform/semantic/branches/1.9/com/exalead/mot/components
    c0 /ng/src/$USER/svn/platform/semantic/branches/1.10/com/exalead/mot/components
    c1 /ng/src/$USER/svn/platform/semantic/branches/1.11/com/exalead/mot/components

    t /ng/src/$USER/svn/platform/semantic/trunk/com/exalead/mot/components/sentimentanalyzer
    t7 /ng/src/$USER/svn/platform/semantic/branches/1.7/com/exalead/mot/components/sentimentanalyzer
    t8 /ng/src/$USER/svn/platform/semantic/branches/1.8/com/exalead/mot/components/sentimentanalyzer
    t9 /ng/src/$USER/svn/platform/semantic/branches/1.9/com/exalead/mot/components/sentimentanalyzer
    t0 /ng/src/$USER/svn/platform/semantic/branches/1.10/com/exalead/mot/components/sentimentanalyzer
    t1 /ng/src/$USER/svn/platform/semantic/branches/1.11/com/exalead/mot/components/sentimentanalyzer

    p /ng/src/$USER/svn/platform/semantic/trunk/com/exalead/mot/tool/proxy
    p7 /ng/src/$USER/svn/platform/semantic/branches/1.7/com/exalead/mot/tool/proxy
    p8 /ng/src/$USER/svn/platform/semantic/branches/1.8/com/exalead/mot/tool/proxy
    p9 /ng/src/$USER/svn/platform/semantic/branches/1.9/com/exalead/mot/tool/proxy
    p0 /ng/src/$USER/svn/platform/semantic/branches/1.10/com/exalead/mot/tool/proxy
    p1 /ng/src/$USER/svn/platform/semantic/branches/1.11/com/exalead/mot/tool/proxy

    b /ng/src/$USER/svn/platform/semantic-build/trunk
    bc /ng/src/$USER/svn/platform/semantic-build/trunk/com/exalead/mot/components
    bo /ng/src/$USER/svn/platform/semantic-build/trunk/org

    cc /ng/src/$USER/svn/platform/cloudview-core/trunk
    cc12 /ng/src/$USER/svn/platform/cloudview-core/branches/1.2
    cc0 /ng/src/$USER/svn/platform/cloudview-core/branches/2.0
    cc1 /ng/src/$USER/svn/platform/cloudview-core/branches/2.1
    cc2 /ng/src/$USER/svn/platform/cloudview-core/branches/2.2
    cc3 /ng/src/$USER/svn/platform/cloudview-core/branches/2.3
    cc4 /ng/src/$USER/svn/platform/cloudview-core/branches/2.4

    cv /ng/src/$USER/svn/platform/cvcore-native/trunk

    v /ng/src/$USER/svn/mercury/cloudview/trunk
    v1 /ng/src/$USER/svn/mercury/cloudview/branches/5.1
    v2 /ng/src/$USER/svn/mercury/cloudview/branches/5.2
    v3 /ng/src/$USER/svn/mercury/cloudview/branches/V6R2013
    v3x /ng/src/$USER/svn/mercury/cloudview/branches/V6R2013x
    v4 /ng/src/$USER/svn/mercury/cloudview/branches/V6R2014

    a /ng/src/$USER/svn/mercury/mercury-adminui/trunk

    n /ng/src/$USER/svn/mercury/cvconsole/trunk/modules/src/com/exalead/cvconsole/
    n2 /ng/src/$USER/svn/mercury/cvconsole/branches/5.2/
    n3 /ng/src/$USER/svn/mercury/cvconsole/branches/V6R2013/
    n3x /ng/src/$USER/svn/mercury/cvconsole/branches/V6R2013x/
    n4 /ng/src/$USER/svn/mercury/cvconsole/branches/V6R2014/

    sd /ng/src/$USER/svn/connectors/sdc/trunk

    sdc /ng/src/$USER/svn/connectors/sdc-connector/trunk

    3 /ng/src/$USER/svn/360

    x /ng/src/$USER/svn/apollo/squirrel/trunk

    op /ng/src/$USER/svn/apps/onepart/trunk/webapps/360-mashup-ui/resources/onePart/js

    solr /ng/src/$USER/svn/git/solr

    k /ng/sdk

    cf /data/$USER/cloudview
    cf1 /data/$USER/cloudview51

    dc /data/compil
    w /data/compil/Wikipedia
)

export LS_COLORS='*.blacklist=90':$LS_COLORS

function std99()
{
    ~/Documents/doc/c-c++/isoiec9899:1999-c-standard.pdf
}

function std98()
{
    ~/Documents/doc/c-c++/isoiec14882:1998-c++-standard.pdf
}

function std03()
{
    ~/Documents/doc/c-c++/isoiec14882:2003-c++-standard.pdf
}

function std11()
{
    ~/Documents/doc/c-c++/isoiec14882:n3242-c++-0x.pdf
}

function todo()
{
    cd ~/Documents/TODO
    e TODO
}

alias zcle="zcl exa"
alias zclx="zcl exatest"

function dbgit()
{
    prefix 'NG=debug'
}
zle -N g dbgit
function vlgit()
{
    prefix 'NG=valgrind'
}
zle -N v vlgit

if [[ -n $abbrev ]]; then
    abbrev[xa]='exatest'
    abbrev[xac]='exatest com.exalead.mot.components.'
    abbrev[xai]='exatest com.exalead.index.'
    abbrev[xei]='exatest exa.io.'
    abbrev[xes]='exatest com.exalead.mot.components.sentimentanalyzer.ut'
    abbrev[xel]='exatest com.exalead.index.list.ut'
fi

source bookmarks
ba semantic/trunk /ng/src/$USER/svn/platform/semantic/trunk/
ba semantic/branches/1.7 /ng/src/$USER/svn/platform/semantic/branches/1.7
ba semantic/branches/1.8 /ng/src/$USER/svn/platform/semantic/branches/1.8

function ngco()
{
    svn co "http://ng/svn/$PWD:s/.*svn\////$1"
}

function ngcon()
{
    svn co -N "http://ng/svn/$PWD:t/$1"
}

function et()
{
    inroot e $@
}

function tt()
{
    pushd `echo $PWD | sed 's@branches/[^/]\+@trunk@'` > /dev/null
}

function bb()
{
    pushd $PWD:s@trunk@branches/*~branches > /dev/null
}

function rt()
{
    pushd `echo $PWD | sed 's@\(branches/[^/]\+\|trunk\).\+@\1@'` > /dev/null
}

function zee()
{
    e /ng/src/$USER/svn/edk/tools/devenv/zsh/exalead.zsh
}

function commitsfrom()
{
    local week wk repo project
    week=`date +%U`

    echo Commits in $1

    repo=${${(s:/:)1}[1]}
    project=${${(s:/:)1}[2]}

    echo "<a href=\"/tmp/zcommits-$project.html\">$project</a> " >> /tmp/zcommits-all.html

    cat >| /tmp/zcommits-$project.html <<EOF
<html>
  <head>
    <title>Commits of last week</title>
    <base target="content"/>
  </head>
  <body>
EOF
    pushd /ng/src/$USER/svn/$1 ; lg -l $2 | sed -n "/$USER/ { s/^r\([0-9]\+\).*\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\).*/\1 \2/p }" | while read commit; do
	wk=`echo $commit | cut -d ' ' -f 2`
	if ((`date -d $wk +%U` + 1 < week)) break
	commit=`echo $commit | cut -d ' ' -f 1`
	echo "<a href=\"http://ng/trac/$repo/changeset/$commit\">$commit</a> "
    done | sort >> /tmp/zcommits-$project.html ; popd > /dev/null
    cat >> /tmp/zcommits-$project.html <<EOF
  </body>
</html>
EOF
}

function commits()
{
    cat >| /tmp/zcommits-all.html <<EOF
<html>
  <head>
    <title>Commits of last week</title>
    <base target="menu2"/>
  </head>
  <body>
EOF

    commitsfrom edk/edk/trunk 500
    commitsfrom edk/tools 100
    commitsfrom platform/semantic/trunk 500
    commitsfrom platform/cloudview-core/trunk 500
    commitsfrom platform/index6/trunk 500

    cat >> /tmp/zcommits-all.html <<EOF
  </body>
</html>
EOF

    cat >| /tmp/zcommits.html <<EOF
<html>
  <head>
    <title>Commits of last week</title>
  </head>
  <frameset rows="5%, 5%, 90%">
    <frame name="menu1" src="/tmp/zcommits-all.html" target=""/>
    <frame name="menu2" src="/tmp/zcommits-semantic.html" target=""/>
    <frame name="content" src="/tmp/zcommits-semantic.html"/>
  </frameset>
</html>
EOF
}

function gdict()
{
    lsof -i -P | grep -i listen | grep `ps aux | grep exa | grep dic0 | sed 's/^[a-z0-9]\+ \+\([0-9]\+\).*/\1/'` | sed 's/.*:\([0-9]\+\).*/\1/' | sort | head -n 1
}

function fgdict()
{
    firefox http://localhost:`gdict`/index.html
}

function api-ui()
{
    lsof -i -P | grep -i listen | grep `ps aux | grep java | grep ss0 | sed 's/^[a-z0-9]\+ \+\([0-9]\+\).*/\1/'` | sed 's/.*:\([0-9]\+\).*/\1/' | sort | head -n 2 | tail -n 1
}

function fapi-ui()
{
    firefox http://localhost:`api-ui`/search-api/search\?q=$2\&l=$1
}

function rup()
{
    vcsroot up $@

    if [[ $PWD = /ng(|[0-9]##)/src/$USER/svn/* ]]; then
	rdup
    fi
}

function setpath()
{
    local oldPath

    if ((# != 2)); then
        echo 'Usage: setpath <dependency> <path>'
    fi

    oldPath=`getpath $1`
    echo Change local path for $1 from ${oldPath##*/} to $2\?
    read y
    if [[ $y != (y|Y) ]]; then
	echo 'Operation aborted' >&2
	return 1
    fi
    inroot sed -i "s/^$1=.*$/$1=$2/" local.ini
    # FIXME add if not already present
    # TODO autocomplete available local checkouts and sdks
}

function projectsgraph()
{
    local dep

    gp()
    {
	pushd $1 > /dev/null
	(mv project.ini project.ini.projectsgraph.bak ; up project.ini) >& /dev/null
	mv local.ini local.ini.projectsgraph.bak >& /dev/null
	dep=`./scripts/sdk-admin getpaths 2> /dev/null | grep $2`
	echo ${1#*/} → ${${dep##*/svn/}#*/}
	mv -f project.ini.projectsgraph.bak project.ini >& /dev/null
	mv -f local.ini.projectsgraph.bak local.ini >& /dev/null
	popd > /dev/null
    }

    pushd /ng/src/$USER/svn/ > /dev/null
    (
	for version in mercury/cloudview/{trunk,branches/*}; do
	    gp $version cloudview-core
	done
	for version in platform/cloudview-core/{trunk,branches/*}; do
	    gp $version index6
	done
	for version in platform/index6/{trunk,branches/*}; do
	    gp $version edk
	done
	for version in edk/edk/{trunk,branches/*}; do
	    echo ${version#*/}
	done
    ) | tee ~/public_html/dependency/`date +%y%m%d`
    popd > /dev/null
}

function n() {
    ngscons $@
}
function nf() {
    [[ $PWD = *mercury-adminui* ]] && ngscons $@ || ngscons -f $@
}
function nd() {
    ngscons -d $@
}
function ndf() {
    [[ $PWD = *mercury-adminui* ]] && ngscons -d $@ || ngscons -df $@
}
function ncdf() {
    [[ $PWD = *mercury-adminui* ]] && ngscons -Cd $@ || ngscons -Cdf $@
}
function rndf() {
    rup && [[ $PWD = *mercury-adminui* ]] && ngscons -d $@ || ngscons -df $@
}

function tmuxjobs() {
    tmux rename-session jobs

    tmux new-window
    tmux send-keys 'cdo' C-m

    tmux new-window
    tmux send-keys 'cdw && ./Arkbot' C-m
    tmux send-keys 'for ((;;)); do ./watchpage.py "Wikipédia:Demande de purge d'"'"'historique" 30; sleep 1m; done' C-m

    tmux last-window
    tmux split-window -h
    tmux send-keys 'htop' C-m
    tmux split-window -v
    tmux send-keys 'kill -15 `ps aux | sed -n '"'"'s/^jroquet \+\([0-9]\+\) \+.*c[h]mon.*/\1/p'"'"'`'
    tmux select-pane -L
    tmux send-keys './chmon.py ~/public_html/chmon -l -r' C-m

    e ~/Documents/TODO/TODO -f org-mode -f show-all
}

function fpath() {
    for file
    do
	if [[ $file:A =~ /data.* ]]; then
            echo /net/${HOST}$file:A
	else
            echo $file:A
	fi
    done
}

pushd $0:h > /dev/null
source paths
popd > /dev/null

function f() {
    dfc -dp /tmp,/dev/sda3,/dev/sdb1,/dev/sdc1 $@
}

function gitblit() {
    case $1 in
	admin)
	    ssh admin@git.paris.exalead.com -p 29418  gitblit users set j13 canAdmin true
	;;
	user)
	    ssh admin@git.paris.exalead.com -p 29418  gitblit users set j13 canAdmin false
        ;;
	*)
	    echo Unknown gitblit command \"$1\" >&2
	;;
    esac
}
